{"ast":null,"code":"'use strict';\n\nvar Buffer = require('safe-buffer').Buffer,\n    crypto = require('crypto'),\n    util = require('util'),\n    Extensions = require('websocket-extensions'),\n    Base = require('./base'),\n    Frame = require('./hybi/frame'),\n    Message = require('./hybi/message');\n\nvar Hybi = function (request, url, options) {\n  Base.apply(this, arguments);\n  this._extensions = new Extensions();\n  this._stage = 0;\n  this._masking = this._options.masking;\n  this._protocols = this._options.protocols || [];\n  this._requireMasking = this._options.requireMasking;\n  this._pingCallbacks = {};\n  if (typeof this._protocols === 'string') this._protocols = this._protocols.split(/ *, */);\n  if (!this._request) return;\n  var protos = this._request.headers['sec-websocket-protocol'],\n      supported = this._protocols;\n\n  if (protos !== undefined) {\n    if (typeof protos === 'string') protos = protos.split(/ *, */);\n    this.protocol = protos.filter(function (p) {\n      return supported.indexOf(p) >= 0;\n    })[0];\n  }\n\n  this.version = 'hybi-' + Hybi.VERSION;\n};\n\nutil.inherits(Hybi, Base);\nHybi.VERSION = '13';\n\nHybi.mask = function (payload, mask, offset) {\n  if (!mask || mask.length === 0) return payload;\n  offset = offset || 0;\n\n  for (var i = 0, n = payload.length - offset; i < n; i++) {\n    payload[offset + i] = payload[offset + i] ^ mask[i % 4];\n  }\n\n  return payload;\n};\n\nHybi.generateAccept = function (key) {\n  var sha1 = crypto.createHash('sha1');\n  sha1.update(key + Hybi.GUID);\n  return sha1.digest('base64');\n};\n\nHybi.GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\nvar instance = {\n  FIN: 0x80,\n  MASK: 0x80,\n  RSV1: 0x40,\n  RSV2: 0x20,\n  RSV3: 0x10,\n  OPCODE: 0x0F,\n  LENGTH: 0x7F,\n  OPCODES: {\n    continuation: 0,\n    text: 1,\n    binary: 2,\n    close: 8,\n    ping: 9,\n    pong: 10\n  },\n  OPCODE_CODES: [0, 1, 2, 8, 9, 10],\n  MESSAGE_OPCODES: [0, 1, 2],\n  OPENING_OPCODES: [1, 2],\n  ERRORS: {\n    normal_closure: 1000,\n    going_away: 1001,\n    protocol_error: 1002,\n    unacceptable: 1003,\n    encoding_error: 1007,\n    policy_violation: 1008,\n    too_large: 1009,\n    extension_error: 1010,\n    unexpected_condition: 1011\n  },\n  ERROR_CODES: [1000, 1001, 1002, 1003, 1007, 1008, 1009, 1010, 1011],\n  DEFAULT_ERROR_CODE: 1000,\n  MIN_RESERVED_ERROR: 3000,\n  MAX_RESERVED_ERROR: 4999,\n  // http://www.w3.org/International/questions/qa-forms-utf-8.en.php\n  UTF8_MATCH: /^([\\x00-\\x7F]|[\\xC2-\\xDF][\\x80-\\xBF]|\\xE0[\\xA0-\\xBF][\\x80-\\xBF]|[\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}|\\xED[\\x80-\\x9F][\\x80-\\xBF]|\\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}|[\\xF1-\\xF3][\\x80-\\xBF]{3}|\\xF4[\\x80-\\x8F][\\x80-\\xBF]{2})*$/,\n  addExtension: function (extension) {\n    this._extensions.add(extension);\n\n    return true;\n  },\n  parse: function (chunk) {\n    this._reader.put(chunk);\n\n    var buffer = true;\n\n    while (buffer) {\n      switch (this._stage) {\n        case 0:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseOpcode(buffer[0]);\n          break;\n\n        case 1:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseLength(buffer[0]);\n          break;\n\n        case 2:\n          buffer = this._reader.read(this._frame.lengthBytes);\n          if (buffer) this._parseExtendedLength(buffer);\n          break;\n\n        case 3:\n          buffer = this._reader.read(4);\n\n          if (buffer) {\n            this._stage = 4;\n            this._frame.maskingKey = buffer;\n          }\n\n          break;\n\n        case 4:\n          buffer = this._reader.read(this._frame.length);\n\n          if (buffer) {\n            this._stage = 0;\n\n            this._emitFrame(buffer);\n          }\n\n          break;\n\n        default:\n          buffer = null;\n      }\n    }\n  },\n  text: function (message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'text');\n  },\n  binary: function (message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'binary');\n  },\n  ping: function (message, callback) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    if (callback) this._pingCallbacks[message] = callback;\n    return this.frame(message, 'ping');\n  },\n  pong: function (message) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    return this.frame(message, 'pong');\n  },\n  close: function (reason, code) {\n    reason = reason || '';\n    code = code || this.ERRORS.normal_closure;\n\n    if (this.readyState <= 0) {\n      this.readyState = 3;\n      this.emit('close', new Base.CloseEvent(code, reason));\n      return true;\n    } else if (this.readyState === 1) {\n      this.readyState = 2;\n\n      this._extensions.close(function () {\n        this.frame(reason, 'close', code);\n      }, this);\n\n      return true;\n    } else {\n      return false;\n    }\n  },\n  frame: function (buffer, type, code) {\n    if (this.readyState <= 0) return this._queue([buffer, type, code]);\n    if (this.readyState > 2) return false;\n    if (buffer instanceof Array) buffer = Buffer.from(buffer);\n    if (typeof buffer === 'number') buffer = buffer.toString();\n    var message = new Message(),\n        isText = typeof buffer === 'string',\n        payload,\n        copy;\n    message.rsv1 = message.rsv2 = message.rsv3 = false;\n    message.opcode = this.OPCODES[type || (isText ? 'text' : 'binary')];\n    payload = isText ? Buffer.from(buffer, 'utf8') : buffer;\n\n    if (code) {\n      copy = payload;\n      payload = Buffer.allocUnsafe(2 + copy.length);\n      payload.writeUInt16BE(code, 0);\n      copy.copy(payload, 2);\n    }\n\n    message.data = payload;\n\n    var onMessageReady = function (message) {\n      var frame = new Frame();\n      frame.final = true;\n      frame.rsv1 = message.rsv1;\n      frame.rsv2 = message.rsv2;\n      frame.rsv3 = message.rsv3;\n      frame.opcode = message.opcode;\n      frame.masked = !!this._masking;\n      frame.length = message.data.length;\n      frame.payload = message.data;\n      if (frame.masked) frame.maskingKey = crypto.randomBytes(4);\n\n      this._sendFrame(frame);\n    };\n\n    if (this.MESSAGE_OPCODES.indexOf(message.opcode) >= 0) this._extensions.processOutgoingMessage(message, function (error, message) {\n      if (error) return this._fail('extension_error', error.message);\n      onMessageReady.call(this, message);\n    }, this);else onMessageReady.call(this, message);\n    return true;\n  },\n  _sendFrame: function (frame) {\n    var length = frame.length,\n        header = length <= 125 ? 2 : length <= 65535 ? 4 : 10,\n        offset = header + (frame.masked ? 4 : 0),\n        buffer = Buffer.allocUnsafe(offset + length),\n        masked = frame.masked ? this.MASK : 0;\n    buffer[0] = (frame.final ? this.FIN : 0) | (frame.rsv1 ? this.RSV1 : 0) | (frame.rsv2 ? this.RSV2 : 0) | (frame.rsv3 ? this.RSV3 : 0) | frame.opcode;\n\n    if (length <= 125) {\n      buffer[1] = masked | length;\n    } else if (length <= 65535) {\n      buffer[1] = masked | 126;\n      buffer.writeUInt16BE(length, 2);\n    } else {\n      buffer[1] = masked | 127;\n      buffer.writeUInt32BE(Math.floor(length / 0x100000000), 2);\n      buffer.writeUInt32BE(length % 0x100000000, 6);\n    }\n\n    frame.payload.copy(buffer, offset);\n\n    if (frame.masked) {\n      frame.maskingKey.copy(buffer, header);\n      Hybi.mask(buffer, frame.maskingKey, offset);\n    }\n\n    this._write(buffer);\n  },\n  _handshakeResponse: function () {\n    var secKey = this._request.headers['sec-websocket-key'],\n        version = this._request.headers['sec-websocket-version'];\n    if (version !== Hybi.VERSION) throw new Error('Unsupported WebSocket version: ' + version);\n    if (typeof secKey !== 'string') throw new Error('Missing handshake request header: Sec-WebSocket-Key');\n\n    this._headers.set('Upgrade', 'websocket');\n\n    this._headers.set('Connection', 'Upgrade');\n\n    this._headers.set('Sec-WebSocket-Accept', Hybi.generateAccept(secKey));\n\n    if (this.protocol) this._headers.set('Sec-WebSocket-Protocol', this.protocol);\n\n    var extensions = this._extensions.generateResponse(this._request.headers['sec-websocket-extensions']);\n\n    if (extensions) this._headers.set('Sec-WebSocket-Extensions', extensions);\n    var start = 'HTTP/1.1 101 Switching Protocols',\n        headers = [start, this._headers.toString(), ''];\n    return Buffer.from(headers.join('\\r\\n'), 'utf8');\n  },\n  _shutdown: function (code, reason, error) {\n    delete this._frame;\n    delete this._message;\n    this._stage = 5;\n    var sendCloseFrame = this.readyState === 1;\n    this.readyState = 2;\n\n    this._extensions.close(function () {\n      if (sendCloseFrame) this.frame(reason, 'close', code);\n      this.readyState = 3;\n      if (error) this.emit('error', new Error(reason));\n      this.emit('close', new Base.CloseEvent(code, reason));\n    }, this);\n  },\n  _fail: function (type, message) {\n    if (this.readyState > 1) return;\n\n    this._shutdown(this.ERRORS[type], message, true);\n  },\n  _parseOpcode: function (octet) {\n    var rsvs = [this.RSV1, this.RSV2, this.RSV3].map(function (rsv) {\n      return (octet & rsv) === rsv;\n    });\n    var frame = this._frame = new Frame();\n    frame.final = (octet & this.FIN) === this.FIN;\n    frame.rsv1 = rsvs[0];\n    frame.rsv2 = rsvs[1];\n    frame.rsv3 = rsvs[2];\n    frame.opcode = octet & this.OPCODE;\n    this._stage = 1;\n    if (!this._extensions.validFrameRsv(frame)) return this._fail('protocol_error', 'One or more reserved bits are on: reserved1 = ' + (frame.rsv1 ? 1 : 0) + ', reserved2 = ' + (frame.rsv2 ? 1 : 0) + ', reserved3 = ' + (frame.rsv3 ? 1 : 0));\n    if (this.OPCODE_CODES.indexOf(frame.opcode) < 0) return this._fail('protocol_error', 'Unrecognized frame opcode: ' + frame.opcode);\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && !frame.final) return this._fail('protocol_error', 'Received fragmented control frame: opcode = ' + frame.opcode);\n    if (this._message && this.OPENING_OPCODES.indexOf(frame.opcode) >= 0) return this._fail('protocol_error', 'Received new data frame but previous continuous frame is unfinished');\n  },\n  _parseLength: function (octet) {\n    var frame = this._frame;\n    frame.masked = (octet & this.MASK) === this.MASK;\n    frame.length = octet & this.LENGTH;\n\n    if (frame.length >= 0 && frame.length <= 125) {\n      this._stage = frame.masked ? 3 : 4;\n      if (!this._checkFrameLength()) return;\n    } else {\n      this._stage = 2;\n      frame.lengthBytes = frame.length === 126 ? 2 : 8;\n    }\n\n    if (this._requireMasking && !frame.masked) return this._fail('unacceptable', 'Received unmasked frame but masking is required');\n  },\n  _parseExtendedLength: function (buffer) {\n    var frame = this._frame;\n    frame.length = this._readUInt(buffer);\n    this._stage = frame.masked ? 3 : 4;\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && frame.length > 125) return this._fail('protocol_error', 'Received control frame having too long payload: ' + frame.length);\n    if (!this._checkFrameLength()) return;\n  },\n  _checkFrameLength: function () {\n    var length = this._message ? this._message.length : 0;\n\n    if (length + this._frame.length > this._maxLength) {\n      this._fail('too_large', 'WebSocket frame length too large');\n\n      return false;\n    } else {\n      return true;\n    }\n  },\n  _emitFrame: function (buffer) {\n    var frame = this._frame,\n        payload = frame.payload = Hybi.mask(buffer, frame.maskingKey),\n        opcode = frame.opcode,\n        message,\n        code,\n        reason,\n        callbacks,\n        callback;\n    delete this._frame;\n\n    if (opcode === this.OPCODES.continuation) {\n      if (!this._message) return this._fail('protocol_error', 'Received unexpected continuation frame');\n\n      this._message.pushFrame(frame);\n    }\n\n    if (opcode === this.OPCODES.text || opcode === this.OPCODES.binary) {\n      this._message = new Message();\n\n      this._message.pushFrame(frame);\n    }\n\n    if (frame.final && this.MESSAGE_OPCODES.indexOf(opcode) >= 0) return this._emitMessage(this._message);\n\n    if (opcode === this.OPCODES.close) {\n      code = payload.length >= 2 ? payload.readUInt16BE(0) : null;\n      reason = payload.length > 2 ? this._encode(payload.slice(2)) : null;\n      if (!(payload.length === 0) && !(code !== null && code >= this.MIN_RESERVED_ERROR && code <= this.MAX_RESERVED_ERROR) && this.ERROR_CODES.indexOf(code) < 0) code = this.ERRORS.protocol_error;\n      if (payload.length > 125 || payload.length > 2 && !reason) code = this.ERRORS.protocol_error;\n\n      this._shutdown(code || this.DEFAULT_ERROR_CODE, reason || '');\n    }\n\n    if (opcode === this.OPCODES.ping) {\n      this.frame(payload, 'pong');\n      this.emit('ping', new Base.PingEvent(payload.toString()));\n    }\n\n    if (opcode === this.OPCODES.pong) {\n      callbacks = this._pingCallbacks;\n      message = this._encode(payload);\n      callback = callbacks[message];\n      delete callbacks[message];\n      if (callback) callback();\n      this.emit('pong', new Base.PongEvent(payload.toString()));\n    }\n  },\n  _emitMessage: function (message) {\n    var message = this._message;\n    message.read();\n    delete this._message;\n\n    this._extensions.processIncomingMessage(message, function (error, message) {\n      if (error) return this._fail('extension_error', error.message);\n      var payload = message.data;\n      if (message.opcode === this.OPCODES.text) payload = this._encode(payload);\n      if (payload === null) return this._fail('encoding_error', 'Could not decode a text frame as UTF-8');else this.emit('message', new Base.MessageEvent(payload));\n    }, this);\n  },\n  _encode: function (buffer) {\n    try {\n      var string = buffer.toString('binary', 0, buffer.length);\n      if (!this.UTF8_MATCH.test(string)) return null;\n    } catch (e) {}\n\n    return buffer.toString('utf8', 0, buffer.length);\n  },\n  _readUInt: function (buffer) {\n    if (buffer.length === 2) return buffer.readUInt16BE(0);\n    return buffer.readUInt32BE(0) * 0x100000000 + buffer.readUInt32BE(4);\n  }\n};\n\nfor (var key in instance) Hybi.prototype[key] = instance[key];\n\nmodule.exports = Hybi;","map":{"version":3,"names":["Buffer","require","crypto","util","Extensions","Base","Frame","Message","Hybi","request","url","options","apply","arguments","_extensions","_stage","_masking","_options","masking","_protocols","protocols","_requireMasking","requireMasking","_pingCallbacks","split","_request","protos","headers","supported","undefined","protocol","filter","p","indexOf","version","VERSION","inherits","mask","payload","offset","length","i","n","generateAccept","key","sha1","createHash","update","GUID","digest","instance","FIN","MASK","RSV1","RSV2","RSV3","OPCODE","LENGTH","OPCODES","continuation","text","binary","close","ping","pong","OPCODE_CODES","MESSAGE_OPCODES","OPENING_OPCODES","ERRORS","normal_closure","going_away","protocol_error","unacceptable","encoding_error","policy_violation","too_large","extension_error","unexpected_condition","ERROR_CODES","DEFAULT_ERROR_CODE","MIN_RESERVED_ERROR","MAX_RESERVED_ERROR","UTF8_MATCH","addExtension","extension","add","parse","chunk","_reader","put","buffer","read","_parseOpcode","_parseLength","_frame","lengthBytes","_parseExtendedLength","maskingKey","_emitFrame","message","readyState","frame","callback","reason","code","emit","CloseEvent","type","_queue","Array","from","toString","isText","copy","rsv1","rsv2","rsv3","opcode","allocUnsafe","writeUInt16BE","data","onMessageReady","final","masked","randomBytes","_sendFrame","processOutgoingMessage","error","_fail","call","header","writeUInt32BE","Math","floor","_write","_handshakeResponse","secKey","Error","_headers","set","extensions","generateResponse","start","join","_shutdown","_message","sendCloseFrame","octet","rsvs","map","rsv","validFrameRsv","_checkFrameLength","_readUInt","_maxLength","callbacks","pushFrame","_emitMessage","readUInt16BE","_encode","slice","PingEvent","PongEvent","processIncomingMessage","MessageEvent","string","test","e","readUInt32BE","prototype","module","exports"],"sources":["/home/faisal/ServerExample/client/client/node_modules/websocket-driver/lib/websocket/driver/hybi.js"],"sourcesContent":["'use strict';\n\nvar Buffer     = require('safe-buffer').Buffer,\n    crypto     = require('crypto'),\n    util       = require('util'),\n    Extensions = require('websocket-extensions'),\n    Base       = require('./base'),\n    Frame      = require('./hybi/frame'),\n    Message    = require('./hybi/message');\n\nvar Hybi = function(request, url, options) {\n  Base.apply(this, arguments);\n\n  this._extensions     = new Extensions();\n  this._stage          = 0;\n  this._masking        = this._options.masking;\n  this._protocols      = this._options.protocols || [];\n  this._requireMasking = this._options.requireMasking;\n  this._pingCallbacks  = {};\n\n  if (typeof this._protocols === 'string')\n    this._protocols = this._protocols.split(/ *, */);\n\n  if (!this._request) return;\n\n  var protos    = this._request.headers['sec-websocket-protocol'],\n      supported = this._protocols;\n\n  if (protos !== undefined) {\n    if (typeof protos === 'string') protos = protos.split(/ *, */);\n    this.protocol = protos.filter(function(p) { return supported.indexOf(p) >= 0 })[0];\n  }\n\n  this.version = 'hybi-' + Hybi.VERSION;\n};\nutil.inherits(Hybi, Base);\n\nHybi.VERSION = '13';\n\nHybi.mask = function(payload, mask, offset) {\n  if (!mask || mask.length === 0) return payload;\n  offset = offset || 0;\n\n  for (var i = 0, n = payload.length - offset; i < n; i++) {\n    payload[offset + i] = payload[offset + i] ^ mask[i % 4];\n  }\n  return payload;\n};\n\nHybi.generateAccept = function(key) {\n  var sha1 = crypto.createHash('sha1');\n  sha1.update(key + Hybi.GUID);\n  return sha1.digest('base64');\n};\n\nHybi.GUID = '258EAFA5-E914-47DA-95CA-C5AB0DC85B11';\n\nvar instance = {\n  FIN:    0x80,\n  MASK:   0x80,\n  RSV1:   0x40,\n  RSV2:   0x20,\n  RSV3:   0x10,\n  OPCODE: 0x0F,\n  LENGTH: 0x7F,\n\n  OPCODES: {\n    continuation: 0,\n    text:         1,\n    binary:       2,\n    close:        8,\n    ping:         9,\n    pong:         10\n  },\n\n  OPCODE_CODES:    [0, 1, 2, 8, 9, 10],\n  MESSAGE_OPCODES: [0, 1, 2],\n  OPENING_OPCODES: [1, 2],\n\n  ERRORS: {\n    normal_closure:       1000,\n    going_away:           1001,\n    protocol_error:       1002,\n    unacceptable:         1003,\n    encoding_error:       1007,\n    policy_violation:     1008,\n    too_large:            1009,\n    extension_error:      1010,\n    unexpected_condition: 1011\n  },\n\n  ERROR_CODES:        [1000, 1001, 1002, 1003, 1007, 1008, 1009, 1010, 1011],\n  DEFAULT_ERROR_CODE: 1000,\n  MIN_RESERVED_ERROR: 3000,\n  MAX_RESERVED_ERROR: 4999,\n\n  // http://www.w3.org/International/questions/qa-forms-utf-8.en.php\n  UTF8_MATCH: /^([\\x00-\\x7F]|[\\xC2-\\xDF][\\x80-\\xBF]|\\xE0[\\xA0-\\xBF][\\x80-\\xBF]|[\\xE1-\\xEC\\xEE\\xEF][\\x80-\\xBF]{2}|\\xED[\\x80-\\x9F][\\x80-\\xBF]|\\xF0[\\x90-\\xBF][\\x80-\\xBF]{2}|[\\xF1-\\xF3][\\x80-\\xBF]{3}|\\xF4[\\x80-\\x8F][\\x80-\\xBF]{2})*$/,\n\n  addExtension: function(extension) {\n    this._extensions.add(extension);\n    return true;\n  },\n\n  parse: function(chunk) {\n    this._reader.put(chunk);\n    var buffer = true;\n    while (buffer) {\n      switch (this._stage) {\n        case 0:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseOpcode(buffer[0]);\n          break;\n\n        case 1:\n          buffer = this._reader.read(1);\n          if (buffer) this._parseLength(buffer[0]);\n          break;\n\n        case 2:\n          buffer = this._reader.read(this._frame.lengthBytes);\n          if (buffer) this._parseExtendedLength(buffer);\n          break;\n\n        case 3:\n          buffer = this._reader.read(4);\n          if (buffer) {\n            this._stage = 4;\n            this._frame.maskingKey = buffer;\n          }\n          break;\n\n        case 4:\n          buffer = this._reader.read(this._frame.length);\n          if (buffer) {\n            this._stage = 0;\n            this._emitFrame(buffer);\n          }\n          break;\n\n        default:\n          buffer = null;\n      }\n    }\n  },\n\n  text: function(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'text');\n  },\n\n  binary: function(message) {\n    if (this.readyState > 1) return false;\n    return this.frame(message, 'binary');\n  },\n\n  ping: function(message, callback) {\n    if (this.readyState > 1) return false;\n    message = message || '';\n    if (callback) this._pingCallbacks[message] = callback;\n    return this.frame(message, 'ping');\n  },\n\n  pong: function(message) {\n      if (this.readyState > 1) return false;\n      message = message ||'';\n      return this.frame(message, 'pong');\n  },\n\n  close: function(reason, code) {\n    reason = reason || '';\n    code   = code   || this.ERRORS.normal_closure;\n\n    if (this.readyState <= 0) {\n      this.readyState = 3;\n      this.emit('close', new Base.CloseEvent(code, reason));\n      return true;\n    } else if (this.readyState === 1) {\n      this.readyState = 2;\n      this._extensions.close(function() { this.frame(reason, 'close', code) }, this);\n      return true;\n    } else {\n      return false;\n    }\n  },\n\n  frame: function(buffer, type, code) {\n    if (this.readyState <= 0) return this._queue([buffer, type, code]);\n    if (this.readyState > 2) return false;\n\n    if (buffer instanceof Array)    buffer = Buffer.from(buffer);\n    if (typeof buffer === 'number') buffer = buffer.toString();\n\n    var message = new Message(),\n        isText  = (typeof buffer === 'string'),\n        payload, copy;\n\n    message.rsv1   = message.rsv2 = message.rsv3 = false;\n    message.opcode = this.OPCODES[type || (isText ? 'text' : 'binary')];\n\n    payload = isText ? Buffer.from(buffer, 'utf8') : buffer;\n\n    if (code) {\n      copy = payload;\n      payload = Buffer.allocUnsafe(2 + copy.length);\n      payload.writeUInt16BE(code, 0);\n      copy.copy(payload, 2);\n    }\n    message.data = payload;\n\n    var onMessageReady = function(message) {\n      var frame = new Frame();\n\n      frame.final   = true;\n      frame.rsv1    = message.rsv1;\n      frame.rsv2    = message.rsv2;\n      frame.rsv3    = message.rsv3;\n      frame.opcode  = message.opcode;\n      frame.masked  = !!this._masking;\n      frame.length  = message.data.length;\n      frame.payload = message.data;\n\n      if (frame.masked) frame.maskingKey = crypto.randomBytes(4);\n\n      this._sendFrame(frame);\n    };\n\n    if (this.MESSAGE_OPCODES.indexOf(message.opcode) >= 0)\n      this._extensions.processOutgoingMessage(message, function(error, message) {\n        if (error) return this._fail('extension_error', error.message);\n        onMessageReady.call(this, message);\n      }, this);\n    else\n      onMessageReady.call(this, message);\n\n    return true;\n  },\n\n  _sendFrame: function(frame) {\n    var length = frame.length,\n        header = (length <= 125) ? 2 : (length <= 65535 ? 4 : 10),\n        offset = header + (frame.masked ? 4 : 0),\n        buffer = Buffer.allocUnsafe(offset + length),\n        masked = frame.masked ? this.MASK : 0;\n\n    buffer[0] = (frame.final ? this.FIN : 0) |\n                (frame.rsv1 ? this.RSV1 : 0) |\n                (frame.rsv2 ? this.RSV2 : 0) |\n                (frame.rsv3 ? this.RSV3 : 0) |\n                frame.opcode;\n\n    if (length <= 125) {\n      buffer[1] = masked | length;\n    } else if (length <= 65535) {\n      buffer[1] = masked | 126;\n      buffer.writeUInt16BE(length, 2);\n    } else {\n      buffer[1] = masked | 127;\n      buffer.writeUInt32BE(Math.floor(length / 0x100000000), 2);\n      buffer.writeUInt32BE(length % 0x100000000, 6);\n    }\n\n    frame.payload.copy(buffer, offset);\n\n    if (frame.masked) {\n      frame.maskingKey.copy(buffer, header);\n      Hybi.mask(buffer, frame.maskingKey, offset);\n    }\n\n    this._write(buffer);\n  },\n\n  _handshakeResponse: function() {\n    var secKey  = this._request.headers['sec-websocket-key'],\n        version = this._request.headers['sec-websocket-version'];\n\n    if (version !== Hybi.VERSION)\n      throw new Error('Unsupported WebSocket version: ' + version);\n\n    if (typeof secKey !== 'string')\n      throw new Error('Missing handshake request header: Sec-WebSocket-Key');\n\n    this._headers.set('Upgrade', 'websocket');\n    this._headers.set('Connection', 'Upgrade');\n    this._headers.set('Sec-WebSocket-Accept', Hybi.generateAccept(secKey));\n\n    if (this.protocol) this._headers.set('Sec-WebSocket-Protocol', this.protocol);\n\n    var extensions = this._extensions.generateResponse(this._request.headers['sec-websocket-extensions']);\n    if (extensions) this._headers.set('Sec-WebSocket-Extensions', extensions);\n\n    var start   = 'HTTP/1.1 101 Switching Protocols',\n        headers = [start, this._headers.toString(), ''];\n\n    return Buffer.from(headers.join('\\r\\n'), 'utf8');\n  },\n\n  _shutdown: function(code, reason, error) {\n    delete this._frame;\n    delete this._message;\n    this._stage = 5;\n\n    var sendCloseFrame = (this.readyState === 1);\n    this.readyState = 2;\n\n    this._extensions.close(function() {\n      if (sendCloseFrame) this.frame(reason, 'close', code);\n      this.readyState = 3;\n      if (error) this.emit('error', new Error(reason));\n      this.emit('close', new Base.CloseEvent(code, reason));\n    }, this);\n  },\n\n  _fail: function(type, message) {\n    if (this.readyState > 1) return;\n    this._shutdown(this.ERRORS[type], message, true);\n  },\n\n  _parseOpcode: function(octet) {\n    var rsvs = [this.RSV1, this.RSV2, this.RSV3].map(function(rsv) {\n      return (octet & rsv) === rsv;\n    });\n\n    var frame = this._frame = new Frame();\n\n    frame.final  = (octet & this.FIN) === this.FIN;\n    frame.rsv1   = rsvs[0];\n    frame.rsv2   = rsvs[1];\n    frame.rsv3   = rsvs[2];\n    frame.opcode = (octet & this.OPCODE);\n\n    this._stage = 1;\n\n    if (!this._extensions.validFrameRsv(frame))\n      return this._fail('protocol_error',\n          'One or more reserved bits are on: reserved1 = ' + (frame.rsv1 ? 1 : 0) +\n          ', reserved2 = ' + (frame.rsv2 ? 1 : 0) +\n          ', reserved3 = ' + (frame.rsv3 ? 1 : 0));\n\n    if (this.OPCODE_CODES.indexOf(frame.opcode) < 0)\n      return this._fail('protocol_error', 'Unrecognized frame opcode: ' + frame.opcode);\n\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && !frame.final)\n      return this._fail('protocol_error', 'Received fragmented control frame: opcode = ' + frame.opcode);\n\n    if (this._message && this.OPENING_OPCODES.indexOf(frame.opcode) >= 0)\n      return this._fail('protocol_error', 'Received new data frame but previous continuous frame is unfinished');\n  },\n\n  _parseLength: function(octet) {\n    var frame = this._frame;\n    frame.masked = (octet & this.MASK) === this.MASK;\n    frame.length = (octet & this.LENGTH);\n\n    if (frame.length >= 0 && frame.length <= 125) {\n      this._stage = frame.masked ? 3 : 4;\n      if (!this._checkFrameLength()) return;\n    } else {\n      this._stage = 2;\n      frame.lengthBytes = (frame.length === 126 ? 2 : 8);\n    }\n\n    if (this._requireMasking && !frame.masked)\n      return this._fail('unacceptable', 'Received unmasked frame but masking is required');\n  },\n\n  _parseExtendedLength: function(buffer) {\n    var frame = this._frame;\n    frame.length = this._readUInt(buffer);\n\n    this._stage = frame.masked ? 3 : 4;\n\n    if (this.MESSAGE_OPCODES.indexOf(frame.opcode) < 0 && frame.length > 125)\n      return this._fail('protocol_error', 'Received control frame having too long payload: ' + frame.length);\n\n    if (!this._checkFrameLength()) return;\n  },\n\n  _checkFrameLength: function() {\n    var length = this._message ? this._message.length : 0;\n\n    if (length + this._frame.length > this._maxLength) {\n      this._fail('too_large', 'WebSocket frame length too large');\n      return false;\n    } else {\n      return true;\n    }\n  },\n\n  _emitFrame: function(buffer) {\n    var frame   = this._frame,\n        payload = frame.payload = Hybi.mask(buffer, frame.maskingKey),\n        opcode  = frame.opcode,\n        message,\n        code, reason,\n        callbacks, callback;\n\n    delete this._frame;\n\n    if (opcode === this.OPCODES.continuation) {\n      if (!this._message) return this._fail('protocol_error', 'Received unexpected continuation frame');\n      this._message.pushFrame(frame);\n    }\n\n    if (opcode === this.OPCODES.text || opcode === this.OPCODES.binary) {\n      this._message = new Message();\n      this._message.pushFrame(frame);\n    }\n\n    if (frame.final && this.MESSAGE_OPCODES.indexOf(opcode) >= 0)\n      return this._emitMessage(this._message);\n\n    if (opcode === this.OPCODES.close) {\n      code   = (payload.length >= 2) ? payload.readUInt16BE(0) : null;\n      reason = (payload.length > 2) ? this._encode(payload.slice(2)) : null;\n\n      if (!(payload.length === 0) &&\n          !(code !== null && code >= this.MIN_RESERVED_ERROR && code <= this.MAX_RESERVED_ERROR) &&\n          this.ERROR_CODES.indexOf(code) < 0)\n        code = this.ERRORS.protocol_error;\n\n      if (payload.length > 125 || (payload.length > 2 && !reason))\n        code = this.ERRORS.protocol_error;\n\n      this._shutdown(code || this.DEFAULT_ERROR_CODE, reason || '');\n    }\n\n    if (opcode === this.OPCODES.ping) {\n      this.frame(payload, 'pong');\n      this.emit('ping', new Base.PingEvent(payload.toString()))\n    }\n\n    if (opcode === this.OPCODES.pong) {\n      callbacks = this._pingCallbacks;\n      message   = this._encode(payload);\n      callback  = callbacks[message];\n\n      delete callbacks[message];\n      if (callback) callback()\n\n      this.emit('pong', new Base.PongEvent(payload.toString()))\n    }\n  },\n\n  _emitMessage: function(message) {\n    var message = this._message;\n    message.read();\n\n    delete this._message;\n\n    this._extensions.processIncomingMessage(message, function(error, message) {\n      if (error) return this._fail('extension_error', error.message);\n\n      var payload = message.data;\n      if (message.opcode === this.OPCODES.text) payload = this._encode(payload);\n\n      if (payload === null)\n        return this._fail('encoding_error', 'Could not decode a text frame as UTF-8');\n      else\n        this.emit('message', new Base.MessageEvent(payload));\n    }, this);\n  },\n\n  _encode: function(buffer) {\n    try {\n      var string = buffer.toString('binary', 0, buffer.length);\n      if (!this.UTF8_MATCH.test(string)) return null;\n    } catch (e) {}\n    return buffer.toString('utf8', 0, buffer.length);\n  },\n\n  _readUInt: function(buffer) {\n    if (buffer.length === 2) return buffer.readUInt16BE(0);\n\n    return buffer.readUInt32BE(0) * 0x100000000 +\n           buffer.readUInt32BE(4);\n  }\n};\n\nfor (var key in instance)\n  Hybi.prototype[key] = instance[key];\n\nmodule.exports = Hybi;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}